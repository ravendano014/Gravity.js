<html>
	<head>
		<title>Gravity Toy</title>
		<script src="Gravity.min.js"></script>
		<script src="Particle.min.js"></script>
		<script src="Magnetosphere.min.js"></script>
		<style>
			body {
				color: #ffffff;
				font-family: Courier New;
				font-size: 11px;
			}
			button {
			  -webkit-border-radius: 0;
			  -moz-border-radius: 0;
			  border-radius: 0px;
			  font-family: Courier New;
			  color: #ffffff;
			  font-size: 11px;
			  background: #000000;
			  padding: 5px 5px 5px 5px;
			  border: solid #ffffff 1px;
			  text-decoration: none;
			  width: 88px;
			  margin-top:2px;
			}

			.txt {
			  -webkit-border-radius: 0;
			  -moz-border-radius: 0;
			  border-radius: 0px;
			  font-family: Courier New;
			  color: #ffffff;
			  font-size: 11px;
			  background: #000000;
			  padding: 5px 5px 5px 5px;
			  border: solid #ffffff 1px;
			  text-decoration: none;
			  margin-left:5px;
			}

			button:hover {
			  background: #ffffff;
			  color: #000000;
			  text-decoration: none;
			}
			.noselect {
				-webkit-touch-callout: none;
				-webkit-user-select: none;
				-khtml-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
				user-select: none;
			}
			#controlbox {
				padding:5px;
				padding-left:20px;
				margin-left:-20px;
				border: solid #ffffff 1px;
				border-left-width: 0px;
				width:88px;
			}
			#homebox {
				font-size:20px;
				position:absolute;
				right:10px;
				top:0px;
				padding:5px;
				padding-top:10px;
				margin-top:-10px;
				padding-right:10px;
				margin-right:-10px;
				padding-left:10px;
				border:solid #ffffff 1px;
				border-right-width:0px;
			}
			a:link {
				color:#0080FF;
			}
			a:visited {
				color:#0000FF;
			}
		</style>
		<script>
			var interval = -1;
			var newParticleSize = 100;
			var currentParticleType = 'matter'; // 'matter' or 'antimatter'

            // Asegura que init() y start() se llamen después de que los scripts estén cargados.
            window.onload = function() {
                // `init()` es una función definida en Gravity.min.js
                // `start()` es una función definida en este mismo script
                init();
                start();
                // Initialize magnetosphere button text
                document.getElementById("toggleMagnetospheresBtn").innerHTML = showMagnetospheres ? "Hide Magnetospheres" : "Show Magnetospheres";
                // Initialize orbit button text
                document.getElementById("toggleOrbitsBtn").innerHTML = showOrbits ? "Hide Orbits" : "Show Orbits";
                // NEW: Initialize gravity well button text
                document.getElementById("toggleGravityWellsBtn").innerHTML = showGravityWells ? "Hide Gravity Wells" : "Show Gravity Wells";
                // NEW: Initialize mass button text
                document.getElementById("toggleMassBtn").innerHTML = showParticleMass ? "Hide Mass" : "Show Mass";
                // Set initial moon mass based on the default selected option
                setMoonMass(document.getElementById("moonSelector").value);
                // Set initial planet mass based on the default selected option
                setCelestialBodyMass(document.getElementById("planetSelector").value);
            };

			function start(){
				if(interval == -1){
					interval = window.setInterval("main();",20);
				}
			}

			function stop(){
				clearInterval(interval);
				interval = -1;
			}

			function generateProto(){
				for (var i = 0; i < 500; i++){
					var rand = Math.random()*2*Math.PI;
					var rand2 = Math.random();
					var x = (100*rand2)*Math.cos(rand);
					var y = (100*rand2)*Math.sin(rand);
					var mag = Math.sqrt(x*x+y*y);
					var particle = new Particle(1000, width/2+x, height/2+y, y*(mag/70), -x*(mag/70), 'matter');
					particleList.push(particle);
				}
				// The original code had ga('send', ...), which is Google Analytics.
				// This might not be available or desired in this environment.
				// Keeping it commented out or removed is safer.
				// ga('send', 'event', 'Gravity.js', 'Protodisk');
			}

			function setSize(size){
				document.getElementById("mass").value=size.toExponential(1).replace("+","");
				// `setNewMass()` es una función definida en Gravity.min.js
				setNewMass(size);
			}

			function clearCanvas(){
				particleList = [];
			}

			// Function to set predefined celestial body masses
			function setCelestialBodyMass(body){
				let mass;
				switch(body){
					case 'sun':
						mass = 1.989e6; // A scaled mass for the Sun, adjust as needed for simulation
						break;
					case 'mercury':
						mass = 3.301e2; // Scaled mass for Mercury
						break;
					case 'venus':
						mass = 4.867e3; // Scaled mass for Venus
						break;
					case 'earth':
						mass = 5.972e3; // Scaled mass for Earth
						break;
					case 'mars':
						mass = 6.417e2; // Scaled mass for Mars
						break;
					case 'jupiter':
						mass = 1.898e6; // Scaled mass for Jupiter
						break;
					case 'saturn':
						mass = 5.683e5; // Scaled mass for Saturn
						break;
					case 'uranus':
						mass = 8.681e4; // Scaled mass for Uranus
						break;
					case 'neptune':
						mass = 1.024e5; // Scaled mass for Neptune
						break;
					default:
						mass = 1e3; // Default to 'Small' if unknown
				}
				setSize(mass);
			}

			// Variable y función para alternar la visibilidad del campo gravitatorio.
			// La lógica principal de `toggleGravityField` reside en Gravity.min.js.
			// Aquí solo se llama a esa función y se actualiza el texto del botón.
			var gravityFieldEnabled = false; // Moved to Gravity.min.js
			function toggleGravityField(){
				// This function will be defined in Gravity.min.js
				// For now, it will simply toggle the state
				gravityFieldEnabled = !gravityFieldEnabled;
				document.getElementById("gravityFieldBtn").innerHTML = gravityFieldEnabled ? "Hide Field" : "Show Field";
			}

            // Function to toggle magnetospheres and update button text
            function toggleMagnetospheresAndButton() {
                // Call the function defined in Gravity.min.js
                toggleMagnetospheres();

                // Update button text
                document.getElementById("toggleMagnetospheresBtn").innerHTML = showMagnetospheres ? "Hide Magnetospheres" : "Show Magnetospheres";
            }

            // Function to toggle orbits and update button text
            function toggleOrbitsAndButton() {
                // Call the function defined in Gravity.min.js
                toggleOrbits();

                // Update button text
                document.getElementById("toggleOrbitsBtn").innerHTML = showOrbits ? "Hide Orbits" : "Show Orbits";
            }

            // NEW: Function to toggle gravity wells and update button text
            function toggleGravityWellsAndButton() {
                // Call the function defined in Gravity.min.js
                toggleGravityWells();

                // Update button text
                document.getElementById("toggleGravityWellsBtn").innerHTML = showGravityWells ? "Hide Gravity Wells" : "Show Gravity Wells";
            }

            // NEW: Function to toggle particle mass and update button text
            function toggleParticleMassAndButton() {
                // Call the function defined in Gravity.min.js
                toggleParticleMass();

                // Update button text
                document.getElementById("toggleMassBtn").innerHTML = showParticleMass ? "Hide Mass" : "Show Mass";
            }

            function placeSolarSystem() {
                clearCanvas();
                // `width` y `height` son variables globales definidas en Gravity.min.js
                var centerX = width / 2;
                var centerY = height / 2;

                // Escalas ajustadas para mejor visibilidad y comportamiento de la simulación.
                // Puedes ajustar estos valores para cambiar el tamaño y la velocidad del sistema solar.
                var distanceScale = 0.5;  // Aumentado para que los planetas sean más visibles
                var massScale = 1e-21;     // Mantener la escala de masa para que el Sol sea dominante
                // velocityScale ya no se usa directamente para escalar velocidades reales,
                // sino que la velocidad orbital se calcula.

                // Datos del sistema solar (masa, distancia media en millones de km)
                var solarSystem = [
                    // Sol (masa enorme, en el centro)
                    {
                        name: "Sun",
                        mass: 1.989e30,
                        distance: 0, // Distancia desde el centro del sistema
                        color: [255, 255, 0] // Amarillo
                    },
                    // Planetas (masa, distancia media en millones de km)
                    // Las velocidades del mundo real se eliminan ya que las calcularemos en función del sistema escalado.
                    { name: "Mercury", mass: 3.30e23, distance: 57.9 * 1.5, color: [169, 169, 169] }, // Gris
                    { name: "Venus", mass: 4.87e24, distance: 108.2 * 1.5, color: [255, 165, 0] },   // Naranja
                    { name: "Earth", mass: 5.97e24, distance: 149.6 * 1.5, color: [0, 0, 255] },     // Azul
                    { name: "Mars", mass: 6.42e23, distance: 228.0 * 1.5, color: [255, 0, 0] },       // Rojo
                    { name: "Jupiter", mass: 1.90e27, distance: 778.5 * 1.5, color: [255, 223, 0] },  // Dorado
                    { name: "Saturn", mass: 5.68e26, distance: 1432.0 * 1.5, color: [210, 180, 140] }, // Canela
                    { name: "Uranus", mass: 8.68e25, distance: 2867.0 * 1.5, color: [173, 216, 230] }, // Azul claro
                    { name: "Neptune", mass: 1.02e26, distance: 4515.0 * 1.5, color: [65, 105, 225] }  // Azul real
                ];

                // Obtener la masa escalada del Sol primero
                var sunMassScaled = solarSystem[0].mass * massScale;

                // Crear objetos del sistema solar
                for (var i = 0; i < solarSystem.length; i++) {
                    var body = solarSystem[i];
                    var mass = body.mass * massScale;
                    var distance = body.distance * distanceScale; // Distancia escalada

                    var x = centerX;
                    var y = centerY;
                    var vx = 0;
                    var vy = 0; // Inicializar velocidades a 0

                    if (body.name === "Sun") {
                        // El Sol comienza en el centro con una velocidad inicial muy pequeña para estabilidad
                        vx = 0.01; // Pequeño "empuje" para evitar un estado perfectamente estático
                        vy = -0.01;
                    } else {
                        // Calcular la magnitud de la velocidad orbital requerida para una órbita circular alrededor del Sol
                        // v = sqrt(G * M_sol / r)
                        // En nuestra simulación, G es efectivamente 1.
                        // Necesitamos asegurarnos de que la distancia no sea cero para este cálculo.
                        if (distance > 0) {
                            var orbitalVelocityMagnitude = Math.sqrt(sunMassScaled / distance);

                            // Para que los planetas no se superpongan al inicio, los distribuimos aleatoriamente
                            var initialAngle = Math.random() * 2 * Math.PI;
                            x = centerX + distance * Math.cos(initialAngle);
                            y = centerY + distance * Math.sin(initialAngle);

                            // Velocidad inicial tangencial a la órbita.
                            // vx = -orbitalVelocityMagnitude * sin(ángulo), vy = orbitalVelocityMagnitude * cos(ángulo)
                            vx = -orbitalVelocityMagnitude * Math.sin(initialAngle);
                            vy = orbitalVelocityMagnitude * Math.cos(initialAngle);
                        }
                    }

                    // Crear partícula
                    // `Particle` es el constructor de partículas definido en Particle.min.js
                    var particle = new Particle(mass, x, y, vx, vy, 'matter', body.name);

                    // Asignar color personalizado si existe
                    if (body.color) {
                        particle.color = body.color;
                        // Recalcular color[3] para el nuevo color personalizado (formato hexadecimal)
                        particle.color[3] = (particle.color[0] << 16 | particle.color[1] << 8 | particle.color[2]).toString(16);
                    }

                    // `particleList` es una variable global definida en Gravity.min.js
                    particleList.push(particle);
                }
            }

            // NEW: Function to set moon mass from selector
            function setMoonMass(mass) {
                // A scaled mass for moons, adjust this factor as needed
                var moonMassScale = 1e-24; // Example scale, adjust to fit your simulation
                var scaledMass = parseFloat(mass) * moonMassScale;
                setSize(scaledMass); // Reutiliza setSize para actualizar el input y la masa global
            }

            // NEW: Function to add a moon (assuming current newMass is set to moon's mass)
            function addMoon() {
                var x = (width / 2);
                var y = (height / 2);

                var vx = 0;
                var vy = 0;

                if (particleList.length > 0) {
                    var targetParticle = null;

                    // Try to find the Sun if it exists
                    for(var i = 0; i < particleList.length; i++) {
                        if (particleList[i].name === "Sun") {
                            targetParticle = particleList[i];
                            break;
                        }
                    }

                    // If no Sun, use the first particle as the target
                    if (!targetParticle) {
                        targetParticle = particleList[0];
                    }

                    // Place the moon at a reasonable distance from the target particle
                    var desiredOrbitDistance = targetParticle.radius * 20; // Adjust as needed
                    if (desiredOrbitDistance < 50) desiredOrbitDistance = 50; // Minimum distance

                    // Random initial angle for placement
                    var initialAngle = Math.random() * 2 * Math.PI;
                    x = targetParticle.x + desiredOrbitDistance * Math.cos(initialAngle);
                    y = targetParticle.y + desiredOrbitDistance * Math.sin(initialAngle);

                    var relativeX = x - targetParticle.x;
                    var relativeY = y - targetParticle.y;
                    var distance = Math.sqrt(relativeX * relativeX + relativeY * relativeY);

                    if (distance > 0) {
                        var orbitalSpeed = Math.sqrt(targetParticle.mass / distance);

                        // Tangential velocity, relative to the target particle's velocity
                        vx = -orbitalSpeed * (relativeY / distance) + targetParticle.vx;
                        vy = orbitalSpeed * (relativeX / distance) + targetParticle.vy;
                    }

                } else {
                    // If no particles, moon appears in the center with a small initial velocity
                    vx = 0.1;
                    vy = -0.1;
                }

                // Add a random name for the moon if desired
                var moonNames = ["Luna", "Phobos", "Deimos", "Io", "Europa", "Ganymede", "Callisto", "Titan", "Rhea", "Iapetus", "Triton", "Charon"];
                var randomMoonName = moonNames[Math.floor(Math.random() * moonNames.length)];

                particleList.push(new Particle(newMass, x, y, vx, vy, currentParticleType, randomMoonName));
            }
		</script>
	</head>
	<body style="background-color:black">
		<div class="noselect">
			Inspired by the classic <a href="http://www.nowykurier.com/toys/gravity/gravity.html">Gravity Toy</a> and rewritten in Javascript.</br>
			Click and drag to add new particles. Hold shift and drag to translate.</br></br>
			<div id="controlbox" style="z-index:4">
				<table>
					<tr>Mass:<input type="text" value="1.0e3" class="txt" style="width:50px;" id="mass"></tr></br>
					<tr><button onclick="setSize(100)">Tiny</button></tr></br>
					<tr><button onclick="setSize(1000)">Small</button></tr></br>
					<tr><button onclick="setSize(10000)">Medium</button></tr></br>
					<tr><button onclick="setSize(100000)">Huge</button></tr></br>
					<tr><button onclick="setSize(1000000)">Enormous</button></tr>
                    <tr>
                        <td>Planet Mass:</td>
                        <td>
                            <select id="planetSelector" onchange="setCelestialBodyMass(this.value)">
                                <option value="sun">Sun</option>
                                <option value="mercury">Mercury</option>
                                <option value="venus">Venus</option>
                                <option value="earth">Earth</option>
                                <option value="mars">Mars</option>
                                <option value="jupiter">Jupiter</option>
                                <option value="saturn">Saturn</option>
                                <option value="uranus">Uranus</option>
                                <option value="neptune">Neptune</option>
                            </select>
                        </td>
                    </tr>
					<tr>
                        <td>Moon Mass:</td>
                        <td>
                            <select id="moonSelector" onchange="setMoonMass(this.value)">
                                <option value="1.0e-1">Small Moon</option>
                                <option value="7.342e22">Earth's Moon</option>
                                <option value="1.076e23">Io</option>
                                <option value="4.800e22">Europa</option>
                                <option value="1.481e23">Ganymede</option>
                                <option value="1.076e23">Callisto</option>
                                <option value="1.345e23">Titan</option>
                                <option value="2.115e22">Rhea</option>
                                <option value="1.896e21">Iapetus</option>
                                <option value="1.345e23">Triton</option>
                                <option value="1.620e21">Charon</option>
                            </select>
                        </td>
                    </tr>
                    <tr><button onclick="addMoon()">Add Moon</button></tr>
				</table>
				<button onclick="start()">Start</button></br>
				<button onclick="stop()">Stop</button></br>
				<button onclick="generateProto()">Protodisk</button></br>
				<button onclick="clearCanvas()">Clear</button></br>
				<button onclick="toggleTrails()">Toggle Trails</button></br>
				<button id="particleTypeBtn" onclick="toggleParticleType()">Matter</button></br>
				<button id="gravityFieldBtn" onclick="toggleGravityField()">Show Field</button></br>
				<button id="toggleNamesBtn" onclick="toggleParticleNames()">Show Names</button></br>
				<button id="toggleMassBtn" onclick="toggleParticleMassAndButton()">Show Mass</button></br>
				<button id="toggleMagnetospheresBtn" onclick="toggleMagnetospheresAndButton()">Show Magnetospheres</button></br>
				<button id="toggleOrbitsBtn" onclick="toggleOrbitsAndButton()">Show Orbits</button></br>
				<button onclick="clearAllParticleOrbits()">Clear Orbits</button></br>
				<button id="toggleGravityWellsBtn" onclick="toggleGravityWellsAndButton()">Show Gravity Wells</button></br> <button onclick="placeSolarSystem()">Solar System</button>
			</div>
		</div>
		<canvas id="canvas" style="z-index:-1;position:absolute;left: 0px;top: 0px;"></canvas>
		<div id="homebox"><a href='/'>Home</a></div>
	</body>
</html>